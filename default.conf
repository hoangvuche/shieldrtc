# Redirect HTTP to HTTPS for both domains
server {
    listen 80;
    server_name corehr.tech *.corehr.tech plusdebt.asia *.plusdebt.asia shieldrtc.com *.shieldrtc.com;
	
    location ^~ /api/qr/internal/ {	
	error_log /var/log/nginx/internal_debug.log debug;
	allow 127.0.0.1;
	allow 172.16.0.0/12;
	deny all;	
        proxy_pass http://plusdebt_app/api/qr/v2.0/;
	proxy_set_header X-Internal-Access true;
    }

    location ^~ /.well-known/acme-challenge/ {
        root /var/www/html;
        allow all;
    }

    location / {
        return 301 https://$host$request_uri;
    }
}

# HTTPS for corehr.tech
server {
    listen 443 ssl;
    server_name corehr.tech *.corehr.tech;

    ssl_certificate /etc/letsencrypt/live/corehr.tech/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/corehr.tech/privkey.pem;

    location / {
	root /var/www/html/public_html;
	index index.html index.htm;
	try_files $uri $uri/ @corehr;
        proxy_pass http://corehr:80;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location @corehr {
	proxy_pass http://corehr:80;
	proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /ws {
        proxy_pass http://corehr:8080/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;
    }
}

# HTTPS for shieldrtc.com
server {
    listen 443 ssl;
    server_name shieldrtc.com *.shieldrtc.com;
   
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header Content-Security-Policy "upgrade-insecure-requests; block-all-mixed-content" always;

    ssl_certificate /etc/letsencrypt/live/shieldrtc.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/shieldrtc.com/privkey.pem;

     location / {
        root /var/www/html/public_html;
        index index.html index.htm;
        try_files $uri $uri/ @shieldrtc;
        proxy_pass http://shieldrtc:80;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location @shieldrtc {
        proxy_pass http://shieldrtc:80;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /ws {
        proxy_pass http://shieldrtc:8080/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;
    }
}

# nh√≥m upstream cho signaling
upstream signaling_backend {
    server app_shieldrtc_signaling1:8081;
    server app_shieldrtc_signaling2:8081;
}

# HTTPS for app.shieldrtc.com
server {
  listen 443 ssl http2;
  server_name app.shieldrtc.com www.app.shieldrtc.com;

  ssl_certificate     /etc/letsencrypt/live/shieldrtc.com/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/shieldrtc.com/privkey.pem;

  # Cho ph√©p camera/microphone cho ch√≠nh origin (khuy√™n d√πng self)
  add_header Permissions-Policy "camera=(self), microphone=(self)" always;

  # HTTP v√†o portal
  location / {
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_pass http://app_shieldrtc_portal:80/;
  }

  # WS c·ªßa portal (c·ªïng 9001)
  location /ws {
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_read_timeout 1d;
    proxy_send_timeout 1d;
    proxy_pass http://app_shieldrtc_portal:9001/;
  }

  # üëâ WS cho signaling (c·ªïng 8081)
  location /signaling {
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_read_timeout 1d;
    proxy_send_timeout 1d;
    proxy_pass http://signaling_backend;
#    proxy_pass http://app_shieldrtc_signaling:8081/;
  }
}

# HTTPS for rtc.shieldrtc.com
server {
  listen 443 ssl;
  server_name rtc.shieldrtc.com;

  ssl_certificate     /etc/letsencrypt/live/rtc.shieldrtc.com/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/rtc.shieldrtc.com/privkey.pem;

  add_header Permissions-Policy "camera=*, microphone=*";

  location / {
    proxy_pass http://livekit:7880;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_read_timeout 86400;
  }
}

# HTTPS for plusdebt.asia
server {
    listen 443 ssl;
    server_name plusdebt.asia *.plusdebt.asia;
    client_max_body_size 20M;

    ssl_certificate /etc/letsencrypt/live/plusdebt.asia/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/plusdebt.asia/privkey.pem;

    location ^~ /op/images/background/ {
        proxy_pass http://plusdebt:80;

        # Kh√¥ng cho d√πng byte-range
        proxy_set_header Range "";
        proxy_hide_header Accept-Ranges;
        proxy_hide_header Content-Range;
        add_header Accept-Ranges "none" always;

        # TRI·ªÜT n√©n hai ƒë·∫ßu
        gzip off;                   # Nginx kh√¥ng n√©n
        gunzip off;                 # n·∫øu c√≥ module gunzip, t·∫Øt lu√¥n
        proxy_set_header Accept-Encoding identity;  # √©p upstream tr·∫£ kh√¥ng n√©n

        # Tr√°nh g·ª≠i Content-Length khi stream -> d√πng chunked
        proxy_buffering off;
        proxy_http_version 1.1;

        expires 7d;
    }


    location / {
        proxy_pass http://plusdebt:80;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /ws {
        proxy_pass http://plusdebt:8080/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;
    }
}
